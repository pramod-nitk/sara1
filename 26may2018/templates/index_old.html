<!DOCTYPE html>
<html lang='en'>
<head>
	<meta class="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<title>Ask Sara</title>
	<!-- Don't forget to add your metadata here -->
	<link rel='stylesheet' href='../static/css/style.min.css' />
	 <meta charset="utf-8">
    <!-- This file has been downloaded from Bootsnipp.com. Enjoy! -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css" rel="stylesheet">
    <style type="text/css">
        
.col-md-2, .col-md-10{
    padding:0;
	
}
label{
width:auto;
height:auto;
color:White;
font-size=14px;
}
.panel{
    margin-bottom: 0px;
	
	
}
.chat-window{
    bottom:0;
	right:0;
    position:fixed;
    float:right;
	

}
.chat-window > div > .panel{
    border-radius: 5px 5px 0 0;
	border-left:1.2px solid gray;
	
}
.icon_minim{
    padding:3px 10px;
}
.msg_container_base{
  background: #e5e5e5;
  margin: 0;
  padding: 0 10px 10px;
  max-height:650px;
  overflow-x:hidden;
}
.top-bar {
  background: #666;
  color: white;
  padding: 10px;
  position: relative;
  overflow: hidden;
}
.msg_receive{
    padding-left:10%;
    margin-left:10px;
	background-color:#01478C;
	border-radius: 20px 20px 20px 0px;
}
.msg_sent{
border-radius: 20px 20px 0px 20px;
    padding-left:10%
    padding-bottom:20px !important;
	padding-right:10
    margin-right:10;
	background-color:#FFFFFF;
}
.messages {
  
  padding: 10px;
  border:1px solid black;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  max-width:auto;
  padding-left:30px
  padding-right:25px

}

.messages > p {
    font-size: 13px;
    margin: 0 0 0.2rem 0;
  }
.messages > time {
    font-size: 11px;
    color: #ccc;
}
.msg_container {
    padding: 10px;
    overflow: hidden;
    display: flex;
	background-color:#FFFFFF;
}
.chatimg {
    display: block;
    width: 80%;
}
.avatar {
    position: relative;

}
.base_receive {

}
.base_receive > .avatar:after {
    content: "";
    position: absolute;
    top: 0;
    right: 0;
    width: 0;
    height: 0;
    border: 5px solid white;
    border-left-color: rgba(0, 0, 0, 0);
    border-bottom-color: rgba(0, 0, 0, 0);
}

.base_sent {
  justify-content: flex-end;
  align-items: flex-end;
}
.base_sent > .avatar:after {
border-radius:15px
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 0;
    border: 5px solid white;
    border-right-color: transparent;
    border-top-color: transparent;
    box-shadow: 1px 1px 2px rgba(black, 0.2); // not quite perfect but close
}

.msg_sent > time{
    float: right;
}



.msg_container_base::-webkit-scrollbar-track
{
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,0.3);
   
}

.msg_container_base::-webkit-scrollbar
{
    width: 12px;
    background-color: #F5F5F5;
}

.msg_container_base::-webkit-scrollbar-thumb
{
    -webkit-box-shadow: inset 0 0 6px rgba(0,0,0,.3);
    background-color: #555;
}

.btn-group.dropup{
    position:fixed;
    left:0px;
    bottom:0;
}

.panel-footer {
    padding: 10px 15px;
    background-color: #ADADAD;
    border-top: 1px solid #ddd;
    border-bottom-right-radius: 3px;
    border-bottom-left-radius: 3px;
	}
	div.chatopen{
	position: fixed;
    bottom: 0px;
    right:100px;
	}
	
	.input-group-btn {
    
    padding-left: 14px;
}

    </style>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>

</head>
<body>
	<!-- Hero(extended) navbar -->
	
	
	
	<!-- Steps -->
	<div class="steps landing__section">
		<img src="../static/citihome.jpg" style="height:1200;weight:1400;"/>
		</div>
	</div>
	<!-- Expanded sections -->
	
	
<script src='../static/js/app.min.js'></script>


<div class="chatopen" >
	<div class="row">
        <div class="round hollow text-center" style="width:200px;" >
       <h4> <a href="#" id="submit" ><span class="glyphicon glyphicon-comment"></span> Open in chat  </a></h4>
	   
        </div>
        
        <hr>
       
	</div>
</div>

 <div class="container pull-right" id="chatbox" >
    <div class="row chat-window col-xs-5 col-md-3 pull-right" id="chat_window_1">
        <div class="col-xs-12 col-md-12">
          <div class="panel panel-default"  >
                <div class="panel-heading top-bar" style="background-color:#1f4d7a">
                    <div class="col-md-8 col-xs-8">
						
                        <h3 class="panel-title" style="font-weight:bold;"><img src="../static/img3.png" class="bot4"></img><font color="white"></font>  </h3>
						
						
                    </div>
                    <div class="col-md-4 col-xs-4" style="text-align: right;">
					  <a href="#">  <i class="fa fa-envelope" style="color:white;" title="coming soon!"></i></a>
					  <!-- <a href="#"> <span id="minim_chat_window" class="glyphicon glyphicon-phone"></span></a>-->
			           <a href="#"> <span id="minim_chat_window" class="glyphicon glyphicon-refresh icon_refresh" style="color:white;" title="refresh!"></span></a>
			     
                        <a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-minus icon_minim" style="color:white;" title="minimize" ></span></a>
                        <a href="#"><span id="minim_chat_window" class="glyphicon glyphicon-remove icon_close" style="color:white;" data-id="chat_window_1" title="Close"></span></a>
                    </div>
                </div>
				<div style="background-color:#ADADAD;word-wrap:break-word; font-color:#1f4d7a;" style="opacity:.5;">
				<p><font color="black">Within this chat window please do not share information such as your CVV or card expiration date. To help safeguard your account we may send you an OTP on your registered mobile number so that you can authorize any request. This chat may be recorded or monitored.
				</font></p></div>
                <div id="messagebody" class="panel-body msg_container_base" style="border-left:1px solid balck;" style="opacity:.5;">
				
				          
		
		
                  
				       
                    </div>

                </div>
                <div class="panel-footer">
                    <div class="input-group">
                        <input id="btn-input" type="text" class="form-control input-sm chat_input" style="margin-right:20px"; placeholder="Write your message here..." required="required" />
                        <span class="input-group-btn">

						<button class='btn btn-default btn-sm' id="start-record-btn" style="border-radius:50%; border-color:green;">  <i class="fa fa-microphone"></i></button>
					     <button class='btn btn-default btn-sm' id="pause-record-btn" style="display:none;border-radius:50%; border-color:green;">  <i class="fa fa-microphone-slash"></i></button>
                        <button class="btn btn-default btn-sm" id="btn-chat" style="background-color:#1f4d7a; font-weight:bold; color:white;">Send</button>
                        </span>
                    </div>
                </div>
        </div>
        </div>

    
  
</div>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script type = "text/javascript" src = "{{ url_for('static', filename = 'js/formfunc26.js') }}" > </script>
<script type="text/javascript">

    var queue=[]
	var attrs = {"appln_ent":"","pan":"","phone":"","account_id":"","last_name":"","score":"","card":"","amount":"","date":"","payment":"","city":"","otp":"","start_date":"","end_date":"","country":"","merchant":"","limit":"","application":""}
	var last_type=""
	var last_intent=""
	var last_attempt=0
	var prev_valid=0
	$("#chatbox").hide();
	$(document).ready(function () {
    $('#submit').click(function () {
	$("#chatbox, #chatbox").toggle();
	
	
			
	
    });
	
});


function include_html(file_name)
{

if(isNaN(file_name))
{
$(function () {
                $.get("../static/"+file_name, function (data) {
                    $("#messagebody").append(data);
                });
				
				
            });
			//document.getElementById("btn-input").disabled = true;
			//document.getElementById("btn-chat").disabled = true;
			console.log("i am out from the demo call");
}
}


function include_wait(file_name)
{

if(isNaN(file_name))
{
$(function () {
                $.get("../static/"+file_name, function (data) {
                    $("#messagebody").append(data);
                });
				
				
            });
			//document.getElementById("btn-input").disabled = true;
			//document.getElementById("btn-chat").disabled = true;
			console.log("i am out from the demo call");
}
}




try {
  var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  var recognition = new SpeechRecognition();
}
catch(e) {
  console.error(e);
  $('.no-browser-support').show();
  $('.app').hide();
}


var noteTextarea = $('#note-textarea');
var instructions = $('#recording-instructions');
var notesList = $('ul#notes');

var noteContent = '';




/*-----------------------------
      Voice Recognition 
------------------------------*/

// If false, the recording will stop after a few seconds of silence.
// When true, the silence period is longer (about 15 seconds),
// allowing us to keep recording even when the user pauses. 
recognition.continuous = true;

// This block is called every time the Speech APi captures a line. 
recognition.onresult = function(event) {

  // event is a SpeechRecognitionEvent object.
  // It holds all the lines we have captured so far. 
  // We only need the current one.
  var current = event.resultIndex;

  // Get a transcript of what was said.
  var transcript = event.results[current][0].transcript;

  // Add the current transcript to the contents of our Note.
  // There is a weird bug on mobile, where everything is repeated twice.
  // There is no official solution so far so we have to handle an edge case.
  var mobileRepeatBug = (current == 1 && transcript == event.results[0][0].transcript);

  if(!mobileRepeatBug) {
    var tb = transcript;
	//alert(tb)
	//document.getElementById("btn-input").value=''
if(tb.trim()!='')
	{
	send("me",tb);
    var val = "hi";
    var entry1 = tb;

  var requestBody={text:tb,"last_type":last_type,"last_intent":last_intent,"last_attempt":last_attempt,"attrs":attrs,"prev_valid":prev_valid}
  console.log(requestBody)
	
	$.ajax({
	url:"/getData",
	type:"post",
	data:JSON.stringify(requestBody),
	dataType:"json",
	contentType:"application/json",
	success: function(data){
		console.log(data)
		console.log("i am in page")
		/*if(data["rp_val"].includes("answer only limited queries")){
			console.log("i am in startpage")
			send("BOT",data["rp_val"])
			include_html('startpage17.html');}
		 else if(data["rp_val"].includes("yes/no")){
			console.log("i am in yes/no")
			send("BOT",data["rp_val"])
			include_html('yes_no.html');}
		else if(data["rp_val"].search("enter the new credit limit") != -1){
		  console.log("i am in slider")
			send("BOT",data["rp_val"])
			include_html('slider5.html');}
		else if(data["rp_val"].search("date") != -1){
		  console.log("i am in slider")
			send("BOT",data["rp_val"])
			include_html('calendar1.html');}
			*/
			 var words = data["rp_val"].split(".");
		res = words.filter(word => word.trim().length >= 1);
			if(data['attrs']['form']!=''){
			console.log(data['attrs']['form'])
			
			for(i=0; i<res.length;i=i+2)
			if(res[i]!="" && res[i+1]!="")
			send("BOT",res[i]+" "+res[i+1])
			else
			send("BOT",res[i])
			include_html(data['attrs']['form']+'.html');
			attrs=data["attrs"]
			attrs['form']=""
			last_attempt=data["last_attempt"]
			last_type=data["last_type"]
			last_intent=data["last_intent"]
			prev_valid=data["prev_valid"]
			}
		else
		{
		    
			for(i=0; i<res.length;i=i+2)
			if(res[i]!="" && res[i+1]!="")
			send("BOT",res[i]+" "+res[i+1])
			else
			send("BOT",res[i])
			console.log("i am in page")
			attrs=data["attrs"]
			last_attempt=data["last_attempt"]
			last_type=data["last_type"]
			last_intent=data["last_intent"]
			prev_valid=data["prev_valid"]
		}
		}
	});
}

  }
};

recognition.onstart = function() { 
  instructions.text('Voice recognition activated. Try speaking into the microphone.');
}

recognition.onspeechend = function() {
  instructions.text('You were quiet for a while so voice recognition turned itself off.');
}

recognition.onerror = function(event) {
  if(event.error == 'no-speech') {
    instructions.text('No speech was detected. Try again.');  
  };
}



/*-----------------------------
      App buttons and input 
------------------------------*/

$('#start-record-btn').on('click', function(e) {
$('#start-record-btn').hide();
$('#pause-record-btn').show();

  if (noteContent.length) {
    noteContent += ' ';
  }
  recognition.start();
});
$('#pause-record-btn').on('click', function(e) {

$('#pause-record-btn').hide();
$('#start-record-btn').show();

  recognition.stop();
  instructions.text('Voice recognition paused.');
});







/*-----------------------------
      Speech Synthesis 
------------------------------*/

function readOutLoud(message) {
	var speech = new SpeechSynthesisUtterance();

  // Set the text and voice attributes.
	speech.text = message;
	speech.volume = 1;
	speech.rate = 1;
	speech.pitch = 1;
  
	window.speechSynthesis.speak(speech);
}

	
	
$(document).on('click', '.panel-heading span.icon_minim', function (e) {
    var $this = $(this);
    if (!$this.hasClass('panel-collapsed')) {
        $this.parents('.panel').find('.panel-body').slideUp();
        $this.addClass('panel-collapsed');
        $this.removeClass('glyphicon-minus').addClass('glyphicon-plus');
    } else {
        $this.parents('.panel').find('.panel-body').slideDown();
        $this.removeClass('panel-collapsed');
        $this.removeClass('glyphicon-plus').addClass('glyphicon-minus');
    }
});
//testing
$(document).on('click', '.panel-heading span.icon_refresh', function (e) {

   attrs = {"appln_ent":"","pan":"","phone":"","account_id":"","last_name":"","score":"","card":"","amount":"","date":"","payment":"","city":"","otp":"","start_date":"","end_date":"","country":"","merchant":"","limit":"","application":""}
	 last_type=""
	last_intent=""
	last_attempt=0
	prev_valid=0
	$("#messagebody").empty()
	setTimeout(send_before,500);
    
});
function send_before()
{

send("BOT","Hi there! It seems I was not able to correctly understand your problem. Let me help you with the list of issues I can resolve as of today.")
include_html("t_reason"+'.html');
//include_html("fraudform5"+'.html');
//include_html("slider6"+'.html');
//include_html("otp3"+'.html');

}

//testing code end


$(document).on('focus', '.panel-footer input.chat_input', function (e) {
    var $this = $(this);
    if ($('#minim_chat_window').hasClass('panel-collapsed')) {
        $this.parents('.panel').find('.panel-body').slideDown();
        $('#minim_chat_window').removeClass('panel-collapsed');
        $('#minim_chat_window').removeClass('glyphicon-plus').addClass('glyphicon-minus');
    }
});
$(document).on('click', '#new_chat', function (e) {
    var size = $( ".chat-window:last-child" ).css("margin-left");
     size_total = parseInt(size) + 400;
   
    var clone = $( "#chat_window_1" ).clone().appendTo( ".container" );
    clone.css("margin-left", size_total);
});
$(document).on('click', '.icon_close', function (e) {
    //$(this).parent().parent().parent().parent().remove();
    $( "#chatbox" ).hide();
});

// send function start

function send_before_res(sender,data,ratio)
{
//setTimeout(include_wait.bind("load","load2.html"),1000*ratio)
/*setTimeout(function(){
document.getElementById("load").remove();
},1100*ratio);*/
//$("#load").empty();
//document.getElementById("load").value=data
setTimeout(send.bind(null, sender,data), 1200 * ratio);
}


function formatAMPM(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    hours = hours % 12;
    hours = hours ? hours : 12; // the hour '0' should be '12'
    minutes = minutes < 10 ? '0'+minutes : minutes;
    var strTime = hours + ':' + minutes + ' ' + ampm;
    return strTime;
}

function send(type,response1){
console.log("i am in inside send page")
	var chat = $("#btn-input").val(); 
var date = formatAMPM(new Date());
if (type =="me") {
    
var body=	'<div class="row msg_container base_receive">'+
                        '<div class="col-md-2 col-xs-2 avatar">'+
                           
                        '</div>'+
                        '<div class="col-md-10 col-xs-10">'+
                            '<div class="messages msg_receive">'+
                                '<label><font color="white">'+response1+'</font></label>'+
                                '<br><label><small>'+date+'</small></label>' +
                            '</div>'+
                        '</div>'+
                    '</div>'
	
	
} else
{
var body =                       '<div class="row msg_container base_sent">' +
						'<div class="col-md-10 col-xs-10 ">' +
                            '<div class="messages msg_sent">' +
                                '<label><font color="#01478C">'+ response1 + '</font></label>'+
                              '<p><small>'+date+'</small></p>' +
                            '</div>' +
                        '</div>' +
                        '<div class="col-md-2 col-xs-2 avatar">' +
                            '<img class="chatimg" src="{{ url_for("static", filename="robo3.png") }}" class=" img-responsive ">' +
                        '</div>' +
					'</div>';
}
$(body).appendTo("#messagebody");
$('#btn-input').val('');
$("#messagebody").animate({ scrollTop: $("#messagebody")[0].scrollHeight}, 'slow');
}


// send function end




$( "#btn-chat" ).click(function() {
	
	var tb = document.getElementById("btn-input").value;
	//alert(tb)
	//document.getElementById("btn-input").value=''
	
	
	if(tb.trim()!='')
	{
	send("me",tb);
    var val = "hi";
    var entry1 = tb;

  var requestBody={text:tb,"last_type":last_type,"last_intent":last_intent,"last_attempt":last_attempt,"attrs":attrs,"prev_valid":prev_valid}
  console.log(requestBody)
	
	$.ajax({
	url:"/getData",
	type:"post",
	data:JSON.stringify(requestBody),
	dataType:"json",
	contentType:"application/json",
	success: function(data){
		console.log(data)
		console.log("i am in page")
		queue.push(data["rp_val"])
		var words = queue.shift().split(".");
		res = words.filter(word => word.trim().length >= 1);

		console.log(res)
		if(isNaN(data['attrs']['form']))
		{
		
		   console.log(data['attrs']['form'])
		   if(res.length%2==0)
		   {
			for(i=0; i<res.length;i=i+2)
			if(res[i]!="" && res[i+1]!="")
			{
			
			
			
			(function (i) {
					
					setTimeout(function () {
					//include_wait("load2.html")
					//document.getElementById("load").remove();
				    send("BOT",res[i]+". "+res[i+1]+".")
					include_wait("load2.html")
					document.getElementById("load").remove();
				}, 1000*i);
				})(i);
			}
		   }
		   else
		   {
		   for(i=0; i<res.length-1;i=i+2)
		   {
			if(res[i]!="" && res[i+1]!="")
			{
			
			(function (i) {
		
					setTimeout(function () {
						//include_wait("load2.html");
						//
						send("BOT",res[i]+". "+res[i+1]+".")
						include_wait("load2.html")
						document.getElementById("load").remove();
				}, 1000*i);
				})(i);
			}
			}
			    setTimeout(function(){
				
				//include_html("load1.html")
				send("BOT",res[i]+".")
				document.getElementById("load").remove();
				
			 },1000*i)
			}
			
			setTimeout(function(){
			include_html(data['attrs']['form']+'.html');
			attrs=data["attrs"]
			attrs['form']=""
			last_attempt=data["last_attempt"]
			last_type=data["last_type"]
			last_intent=data["last_intent"]
			prev_valid=data["prev_valid"]
			},1000*i);
			}
		else
		{
		    
			console.log(res)
			if(res.length%2==0)
		   {
			for(i=0; i<res.length;i=i+2)
			if(res[i]!="" && res[i+1]!="")
			{
			
					(function (i) {
					
					setTimeout(function () 
					{
					//include_wait("load2.html")
					//document.getElementById("load").remove();
				    send("BOT",res[i]+". "+res[i+1]+".")
					include_wait("load2.html")
					document.getElementById("load").remove();
				}, 1000*i);
				})(i);
			}
		   }
		   else
		   {
		   for(i=0; i<res.length-1;i=i+2)
		   {
			if(res[i]!="" && res[i+1]!="")
			{
			
			(function (i) {
			
					
					setTimeout(function () {
					//include_wait("load2.html")
					//document.getElementById("load").remove();
				    send("BOT",res[i]+". "+res[i+1]+".")
					
					include_wait("load2.html")
					document.getElementById("load").remove();
				}, 1000*i);
				})(i);
			}
			}
			setTimeout(function(){
			
			//include_html("load1.html")
			send("BOT",res[i]+".")
			document.getElementById("load").remove();
			},1000*i);
			}
			console.log("i am in page")
			attrs=data["attrs"]
			last_attempt=data["last_attempt"]
			last_type=data["last_type"]
			last_intent=data["last_intent"]
			prev_valid=data["prev_valid"]
		}
		$("#load").empty();
		
		}
	});
}





//send()
});

$('#btn-input').keypress(function (e) {
  if (e.which == 13) {
  var tb = document.getElementById("btn-input").value;
	if(tb.trim()!='')
	{
	send("me",tb);
    var val = "hi";
    var entry1 = tb;

  var requestBody={text:tb,"last_type":last_type,"last_intent":last_intent,"last_attempt":last_attempt,"attrs":attrs,"prev_valid":prev_valid}
  console.log(requestBody)
	
	$.ajax({
	url:"/getData",
	type:"post",
	data:JSON.stringify(requestBody),
	dataType:"json",
	contentType:"application/json",
	success: function(data){
		console.log(data)
		console.log("i am in page")
		queue.push(data["rp_val"])
		var words = queue.shift().split(".");
		res = words.filter(word => word.trim().length >= 1);

		console.log(res)
		if(isNaN(data['attrs']['form']))
		{
		   
		   console.log(data['attrs']['form'])
		   if(res.length%2==0)
		   {
		   
			for(i=0; i<res.length;i=i+2)
			{
			//alert("isNaN(data['attrs']['form'] i am in even call")
			if(res[i]!="" && res[i+1]!="")
			{
			
				    send_before_res("BOT",res[i]+". "+res[i+1]+".",i+1)
						
		   }
		   }
		   }
		   else
		   {
		   for(i=0; i<res.length-1;i=i+2)
		   {
			if(res[i]!="" && res[i+1]!="")
			{
			
									send_before_res("BOT",res[i]+". "+res[i+1]+".",i+1)

			}
			
			}
			 send_before_res("BOT",res[i]+".",i+1)

			}
			
			setTimeout(function(){
			include_html(data['attrs']['form']+'.html');
			attrs=data["attrs"]
			attrs['form']=""
			last_attempt=data["last_attempt"]
			last_type=data["last_type"]
			last_intent=data["last_intent"]
			prev_valid=data["prev_valid"]
			},1300*(i+1))
			}
		else
		{
		    
			console.log(res)
			if(res.length%2==0)
		   {
			for(i=0; i<res.length;i=i+2)
			if(res[i]!="" && res[i+1]!="")
			{
			
					
				    send_before_res("BOT",res[i]+". "+res[i+1]+".",i+1)
				
			}
		   }
		   else
		   {
		   for(i=0; i<res.length-1;i=i+2)
		   {
			if(res[i]!="" && res[i+1]!="")
			{
			

					
					
				    send_before_res("BOT",res[i]+". "+res[i+1]+".",i+1)
					
				
			}
			}
			
			send_before_res("BOT",res[i]+".",i+1)
			
			}
			console.log("i am in page")
			attrs=data["attrs"]
			last_attempt=data["last_attempt"]
			last_type=data["last_type"]
			last_intent=data["last_intent"]
			prev_valid=data["prev_valid"]
		}
		$("#load").empty();
		
		}
	});
}



	//send()
  }
});





</script>

</body>
</html>